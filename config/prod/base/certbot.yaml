apiVersion: v1
kind: ServiceAccount
metadata:
  name: certbot-ksa
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: letsencrypt-job
  labels:
    app: letsencrypt
spec:
  schedule: "0 2 * * 1/3" 
  concurrencyPolicy: Forbid
  startingDeadlineSeconds: 120
  jobTemplate:
    spec:
      template:
        metadata:
          name: letsencrypt
          labels:
            app: letsencrypt
        spec:
          serviceAccountName: certbot-ksa
          containers:
          - image: gcr.io/k8s-dice-magic/letsencrypt:latest
            name: letsencrypt
            imagePullPolicy: IfNotPresent
            ports:
            - name: letsencrypt
              containerPort: 8080
            envFrom:
            - configMapRef:
                name: certbot-config
            securityContext:
              privileged: false
              allowPrivilegeEscalation: false
              runAsNonRoot: true
              capabilities:
                drop: ["ALL"]
          restartPolicy: Never
      backoffLimit: 0